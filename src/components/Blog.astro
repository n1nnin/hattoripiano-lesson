---
// ビルド時にアメブロのRSSフィードを取得
let posts: { title: string; link: string; date: string; description: string }[] = [];

try {
  const res = await fetch('https://rssblog.ameba.jp/hiyorimaru1206/rss.html');
  const xml = await res.text();

  // RSSからアイテムを抽出
  const items = xml.split('<item rdf:about=').slice(1);
  posts = items.slice(0, 6).map((item) => {
    const title = item.match(/<title>([^<]*)<\/title>/)?.[1] ?? '';
    const link = item.match(/<link>([^<]*)<\/link>/)?.[1] ?? '';
    const dateStr = item.match(/<dc:date>([^<]*)<\/dc:date>/)?.[1] ?? '';
    const description = item.match(/<description>\s*([\s\S]*?)\s*<\/description>/)?.[1]?.trim() ?? '';

    // 日付をフォーマット
    const d = new Date(dateStr);
    const date = `${d.getFullYear()}.${String(d.getMonth() + 1).padStart(2, '0')}.${String(d.getDate()).padStart(2, '0')}`;

    // descriptionを80文字に
    const shortDesc = description.length > 80 ? description.slice(0, 80) + '…' : description;

    return { title, link, date, description: shortDesc };
  });
} catch (e) {
  // RSSフェッチ失敗時は空配列のまま
}
---

<section id="blog" class="py-20 md:py-28 bg-cream">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Section Heading -->
    <div class="text-center mb-14 observe-fade">
      <p class="font-accent text-2xl text-brown-warm mb-2">Blog</p>
      <h2 class="font-heading text-3xl md:text-4xl font-bold text-brown">教室ブログ</h2>
      <p class="mt-4 text-brown-accent">レッスンの様子や日々のできごとをお届けしています</p>
    </div>

    {posts.length > 0 ? (
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-10">
        {posts.map((post) => (
          <a
            href={post.link}
            target="_blank"
            rel="noopener noreferrer"
            class="group block bg-white rounded-2xl shadow-md overflow-hidden hover:shadow-lg transition-shadow duration-300 observe-fade"
          >
            <div class="p-6">
              <time class="text-sm text-brown-warm font-medium">{post.date}</time>
              <h3 class="font-heading text-lg font-bold text-brown mt-2 mb-3 group-hover:text-brown-accent transition-colors duration-300 line-clamp-2">
                {post.title}
              </h3>
              <p class="text-sm text-brown-accent leading-relaxed line-clamp-3">
                {post.description}
              </p>
            </div>
            <div class="px-6 pb-4">
              <span class="text-sm text-brown-warm group-hover:underline">
                続きを読む →
              </span>
            </div>
          </a>
        ))}
      </div>
    ) : (
      <p class="text-center text-brown-accent">記事を読み込み中です...</p>
    )}

    <!-- Blog Link -->
    <div class="text-center observe-fade">
      <a
        href="https://ameblo.jp/hiyorimaru1206/"
        target="_blank"
        rel="noopener noreferrer"
        class="inline-block border-2 border-brown-accent text-brown-accent hover:bg-brown-accent hover:text-white font-heading font-medium rounded-full px-8 py-3 transition-colors duration-300"
      >
        ブログ一覧を見る
      </a>
    </div>
  </div>
</section>
